<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,height=device-height">
    <title>带图片遮罩的词云</title>
    <style>::-webkit-scrollbar{display:none;}html,body{overflow:hidden;height:100%;margin:0;}#mountNode canvas{display:block;margin:auto;}</style>
</head>
<body>
<div id="mountNode"></div>
<script>/*Fixing iframe window.innerHeight 0 issue in Safari*/document.body.clientHeight;</script>
<script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.g2-3.5.1/dist/g2.min.js"></script>
<script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.data-set-0.10.1/dist/data-set.min.js"></script>
<script src="https://gw.alipayobjects.com/os/antv/assets/lib/jquery-3.2.1.min.js"></script>
<script src="https://gw.alipayobjects.com/os/antv/assets/lib/lodash-4.17.4.min.js"></script>
<script>
  function getTextAttrs(cfg) {
    return _.assign({}, cfg.style, {
      fillOpacity: cfg.opacity,
      fontSize: cfg.origin._origin.size,
      rotate: cfg.origin._origin.rotate,
      text: cfg.origin._origin.text,
      textAlign: 'center',
      fontFamily: cfg.origin._origin.font,
      fill: cfg.color,
      textBaseline: 'Alphabetic'
    });
  }

  // 给point注册一个词云的shape
  G2.Shape.registerShape('point', 'cloud', {
    drawShape: function drawShape(cfg, container) {
      var attrs = getTextAttrs(cfg);
      return container.addShape('text', {
        attrs: _.assign(attrs, {
          x: cfg.x,
          y: cfg.y
        })
      });
    }
  });
  $.getJSON('./userword_output.json', function(data) {
    var dv = new DataSet.View().source(data);
    var range = dv.range('value');
    var min = range[0];
    var max = range[1];
    var imageMask = new Image();
    imageMask.crossOrigin = '';
    // imageMask.src = './photo.png';
    imageMask.src = 'https://gw.alipayobjects.com/mdn/rms_d89f6e/afts/img/A*9meiRbeDdaEAAAAAAAAAAABkARQnAQ';
    imageMask.onload = function() {
      // 取得图片比例
      var zWidth = window.innerWidth;
      var zHeight = window.innerHeight;
      var imgWidth = imageMask.width;
      var imgHeight = imageMask.height;
      var winRadio = zWidth / zHeight;
      var imgRadio = imgWidth / imgHeight;
      var whArr = imgRadio > winRadio ? [zWidth, zWidth / imgRadio] : [zHeight * imgRadio, zHeight];
      /**
       * 更改文字比例
       */
      var fontSizeMax = whArr[0] / 25;
      /**
       * 更改文字间距
       */
      var zPadding = whArr[0] / 300;
      var fontSizeMin = Math.max.apply(Math, [Math.sqrt(fontSizeMax), fontSizeMax / 2.5, 9]);
      // 绘制
      dv.transform({
        type: 'tag-cloud',
        fields: ['name', 'value'],
        imageMask: imageMask,
        font: 'Verdana',
        size: whArr, // 宽高设置最好根据 imageMask 做调整
        padding: zPadding,
        timeInterval: 5000, // max execute time
        rotate: function rotate() {
          var random = ~~(Math.random() * 4) % 4;
          if (random == 2) {
            random = 0;
          }
          return random * 0; // 0, 90, 270
          // return random * 45; // 0, 90, 270
        },
        fontSize: function fontSize(d) {
          return (d.value - min) / (max - min) * (fontSizeMax - fontSizeMin) + fontSizeMin;
        }
      });
      var chart = new G2.Chart({
        container: 'mountNode',
        width: whArr[0], // 宽高设置最好根据 imageMask 做调整
        height: whArr[1],
        padding: 0
      });
      chart.source(dv, {
        x: {
          nice: false
        },
        y: {
          nice: false
        }
      });
      chart.legend(false);
      chart.axis(false);
      chart.tooltip({
        showTitle: false
      });
      chart.coord().reflect();
      chart.point().position('x*y').color('text').shape('cloud');
      chart.render();
    };
  });
</script>
</body>
</html>
